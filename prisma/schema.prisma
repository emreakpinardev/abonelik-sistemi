generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  id               String         @id @default(uuid())
  name             String
  description      String?
  price            Float
  currency         String         @default("TRY")
  interval         String         @default("MONTHLY")
  intervalCount    Int            @default(1)
  trialDays        Int            @default(0)
  shopifyProductId String?
  shopifyVariantId String?
  iyzicoProductReferenceCode     String?
  iyzicoPricingPlanReferenceCode String?
  active           Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  groupName        String?
  isTemplate       Boolean        @default(false)
  subscriptions    Subscription[]
}

model Subscription {
  id                    String    @id @default(uuid())
  customerEmail         String
  customerName          String
  customerPhone         String?
  customerAddress       String?
  customerCity          String?
  customerCountry       String    @default("Turkey")
  customerIp            String?
  iyzicoSubscriptionRef String?   @unique
  iyzicoCustomerRef     String?
  iyzicoCardToken       String?
  iyzicoCardUserKey     String?
  shopifyCustomerId     String?
  lastShopifyOrderId    String?
  status                String    @default("PENDING")
  startDate             DateTime?
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  nextPaymentDate       DateTime?
  cancelledAt           DateTime?
  planId                String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  payments              Payment[]
  plan                  Plan      @relation(fields: [planId], references: [id])

  @@index([status])
  @@index([nextPaymentDate])
  @@index([customerEmail])
}

model Payment {
  id                         String       @id @default(uuid())
  amount                     Float
  currency                   String       @default("TRY")
  status                     String       @default("PENDING")
  iyzicoPaymentId            String?
  iyzicoPaymentTransactionId String?
  errorMessage               String?
  shopifyOrderId             String?
  shopifyOrderName           String?
  subscriptionId             String
  createdAt                  DateTime     @default(now())
  subscription               Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([status])
}

model ShopifyStore {
  id          String    @id @default(dbgenerated("gen_random_uuid()"))
  shop        String    @unique
  accessToken String
  scopes      String?
  installedAt DateTime? @default(now()) @db.Timestamp(6)
}
